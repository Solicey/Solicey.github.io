<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>03. 光栅化与抗锯齿 | 云知计划</title>
    
    
        <meta name="keywords" content="CS,图形学">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="参考资料：  games101作业02：Triangles and Z-buffering Games101 作业2 Triangles and Z-buffering(源码+常见问题)  我们将以作业02作为本小节的动机。 作业内容在上次作业中，虽然我们在屏幕上画出一个线框三角形，但这看起来并不是那么的有趣。所以这一次我们继续推进一步——在屏幕上画出一个实心三角形，换言之，栅格化一个三角形。上一">
<meta property="og:type" content="article">
<meta property="og:title" content="03. 光栅化与抗锯齿">
<meta property="og:url" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/index.html">
<meta property="og:site_name" content="云知计划">
<meta property="og:description" content="参考资料：  games101作业02：Triangles and Z-buffering Games101 作业2 Triangles and Z-buffering(源码+常见问题)  我们将以作业02作为本小节的动机。 作业内容在上次作业中，虽然我们在屏幕上画出一个线框三角形，但这看起来并不是那么的有趣。所以这一次我们继续推进一步——在屏幕上画出一个实心三角形，换言之，栅格化一个三角形。上一">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/1.jpg">
<meta property="og:image" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/2.jpg">
<meta property="og:image" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/4.jpg">
<meta property="og:image" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/3.jpg">
<meta property="article:published_time" content="2022-07-09T01:52:32.481Z">
<meta property="article:modified_time" content="2022-07-09T08:06:48.117Z">
<meta property="article:author" content="Solitude21">
<meta property="article:tag" content="CS">
<meta property="article:tag" content="图形学">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://solicey.github.io/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/1.jpg">
    

    

    
        <link rel="icon" href="/css/images/Yunzhi.png">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="云知计划" type="application/atom+xml">
</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">云知计划</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            图形学
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            GAMES101
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/GAMES101/2022-07-07-%5B01%5D%E5%9F%BA%E6%9C%AC%E5%8F%98%E6%8D%A2%E7%9F%A9%E9%98%B5%E6%80%BB%E7%BB%93/">01. 基本变换矩阵总结</a></li>  <li class="file"><a href="/wiki/GAMES101/2022-07-08-%5B02%5D%E8%A7%86%E5%9B%BE%E5%8F%98%E6%8D%A2/">02. 视图变换</a></li>  <li class="file active"><a href="/wiki/GAMES101/2022-07-09-%5B03%5D%E5%85%89%E6%A0%85%E5%8C%96/">03. 光栅化与抗锯齿</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            日志
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/Logs/hello-world/">云知计划3.0</a></li>  <li class="file"><a href="/wiki/Logs/Hexo%E5%8D%9A%E5%AE%A2%E5%A4%87%E5%BF%98%E5%BD%95/">Hexo博客备忘录</a></li>  </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-GAMES101/2022-07-09-[03]光栅化" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/">图形学</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/">GAMES101</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/CS/" rel="tag">CS</a>, <a class="tag-link-link" href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" rel="tag">图形学</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/GAMES101/2022-07-09-%5B03%5D%E5%85%89%E6%A0%85%E5%8C%96/">
            <time datetime="2022-07-09T01:52:32.481Z" itemprop="datePublished">2022-07-09</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            03. 光栅化与抗锯齿
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">Catalogue</strong>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%86%85%E5%AE%B9"><span class="toc-number">1.</span> <span class="toc-text">作业内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%83%8F%E7%B4%A0%E4%B8%AD%E5%BF%83%E7%82%B9%E6%98%AF%E5%90%A6%E5%9C%A8%E4%B8%89%E8%A7%92%E5%BD%A2%E5%86%85"><span class="toc-number">2.1.</span> <span class="toc-text">判断像素中心点是否在三角形内</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E6%A0%85%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">光栅化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%97%E9%94%AF%E9%BD%BF-%E5%8F%8D%E8%B5%B0%E6%A0%B7"><span class="toc-number">4.</span> <span class="toc-text">抗锯齿&#x2F;反走样</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E9%87%87%E6%A0%B7%E5%8F%8D%E8%B5%B0%E6%A0%B7%EF%BC%88Super-Sampling-AA%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">超采样反走样（Super Sampling AA）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E9%87%87%E6%A0%B7%E5%8F%8D%E8%B5%B0%E6%A0%B7%EF%BC%88Multi-Sampling-AA%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">多采样反走样（Multi-Sampling AA）</span></a></li></ol></li></ol>
                </div>
            
        
        
            <p>参考资料：</p>
<ol>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/why18767183086/article/details/107369094?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165733197016782395324187%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165733197016782395324187&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-2-107369094-null-null.142^v32^pc_rank_34,185^v2^control&amp;utm_term=games101%E4%BD%9C%E4%B8%9A2&amp;spm=1018.2226.3001.4187">games101作业02：Triangles and Z-buffering</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/qq_43213160/article/details/124075387?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=games101%E4%BD%9C%E4%B8%9A2&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-124075387.nonecase&amp;spm=1018.2226.3001.4187">Games101 作业2 Triangles and Z-buffering(源码+常见问题)</a></li>
</ol>
<p>我们将以作业02作为本小节的动机。</p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>在上次作业中，虽然我们在屏幕上画出一个线框三角形，但这看起来并不是那么的有趣。所以这一次我们继续推进一步——在屏幕上画出一个实心三角形，换言之，栅格化一个三角形。上一次作业中，在视口变化之后，我们调用了函数<code>rasterize_wireframe(const Triangle&amp; t)</code>。但这一次，你需要自己填写并调用函数 <code>rasterize_triangle(const Triangle&amp; t)</code>。</p>
<p>该函数的内部工作流程如下：</p>
<ul>
<li>创建三角形的 2 维 bounding box。</li>
<li>遍历此 bounding box 内的所有像素（使用其整数索引）。然后，使用像素中心的屏幕空间坐标来检查中心点是否在三角形内。</li>
<li>如果在内部，则将其位置处的插值深度值 (interpolated depth value) 与深度缓冲区 (depth buffer) 中的相应值进行比较。</li>
<li>如果当前点更靠近相机，请设置像素颜色并更新深度缓冲区 (depth buffer)。</li>
</ul>
<p>你需要修改的函数如下：</p>
<ul>
<li><code>rasterize_triangle()</code>: 执行三角形栅格化算法</li>
<li><code>static bool insideTriangle()</code>: 测试点是否在三角形内。你可以修改此函数的定义，这意味着，你可以按照自己的方式更新返回类型或函数参数。</li>
</ul>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="判断像素中心点是否在三角形内"><a href="#判断像素中心点是否在三角形内" class="headerlink" title="判断像素中心点是否在三角形内"></a>判断像素中心点是否在三角形内</h3><p>想要<a target="_blank" rel="external nofollow noopener noreferrer" href="https://baike.baidu.com/item/%E5%85%89%E6%A0%85%E5%8C%96/10008122?fr=aladdin"><strong>光栅化</strong></a>一个三角形，就得先判断屏幕上的像素是否在三角形的范围内。</p>
<p>如果把三角形看作由首尾相连的向量围成，那么我们只需判断像素中心点是否在这三个向量的同一侧。假设三角形三个顶点分别为$A,B,C$，像素中心点为$P$，我们进行三次叉乘计算：$\vec{AB}\times \vec{AP},\vec{BC}\times \vec{BP},\vec{CA}\times \vec{CP}$。如果三次运算的结果<strong>都为正或都为负</strong>，那么$P$点在三角形内部。对应代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">insideTriangle</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">const</span> Vector3f* _v)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// TODO : Implement this function to check if the point (x, y) is inside the triangle represented by _v[0], _v[1], _v[2]</span></span><br><span class="line">    <span class="function">Eigen::Vector2f <span class="title">P</span><span class="params">(x, y)</span></span>;</span><br><span class="line">    Eigen::Vector2f A = _v[<span class="number">0</span>].<span class="built_in">head</span>(<span class="number">2</span>),</span><br><span class="line">                    B = _v[<span class="number">1</span>].<span class="built_in">head</span>(<span class="number">2</span>),</span><br><span class="line">                    C = _v[<span class="number">2</span>].<span class="built_in">head</span>(<span class="number">2</span>);</span><br><span class="line">  </span><br><span class="line">    Eigen::Vector2f AP = P - A,</span><br><span class="line">                    BP = P - B,</span><br><span class="line">                    CP = P - C,</span><br><span class="line">                    AB = B - A,</span><br><span class="line">                    BC = C - B,</span><br><span class="line">                    CA = A - C;</span><br><span class="line">    <span class="type">float</span> c1 = AB[<span class="number">0</span>] * AP[<span class="number">1</span>] - AB[<span class="number">1</span>] * AP[<span class="number">0</span>];</span><br><span class="line">    <span class="type">float</span> c2 = BC[<span class="number">0</span>] * BP[<span class="number">1</span>] - BC[<span class="number">1</span>] * BP[<span class="number">0</span>];</span><br><span class="line">    <span class="type">float</span> c3 = CA[<span class="number">0</span>] * CP[<span class="number">1</span>] - CA[<span class="number">1</span>] * CP[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eigen库不支持二维向量的叉乘运算，需要手动列式</span></span><br><span class="line">    <span class="keyword">if</span> ((c1 &gt; <span class="number">0</span> &amp;&amp; c2 &gt; <span class="number">0</span> &amp;&amp; c3 &gt; <span class="number">0</span>) ||</span><br><span class="line">        (c1 &lt; <span class="number">0</span> &amp;&amp; c2 &lt; <span class="number">0</span> &amp;&amp; c3 &lt; <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="光栅化"><a href="#光栅化" class="headerlink" title="光栅化"></a>光栅化</h2><p>首先，我们用一个包围盒确定要进行像素中心点判断的范围，这样就能避免每画一个三角形就要遍历整个屏幕的行为。如果我们采用AABB，即<strong>轴对齐包围盒</strong>，那么比较三个顶点的x值y值大小即可确定其范围。为了方便遍历像素点，包围盒的边界需要向外取整。</p>
<p>接下来，我们遍历包围盒中的像素点，用<code>insideTriangle</code>函数判断其是否在三角形范围内。如果在，那么通过<strong>重心坐标计算</strong>对应的插值深度值，并进行深度检测，即与深度缓冲区的值进行比较。如果当前点更靠近相机，那么设置像素的颜色，并更新深度缓冲区对应的值。代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Screen space rasterization</span></span><br><span class="line"><span class="type">void</span> rst::rasterizer::<span class="built_in">rasterize_triangle</span>(<span class="type">const</span> Triangle&amp; t) &#123;</span><br><span class="line">    <span class="keyword">auto</span> v = t.<span class="built_in">toVector4</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 确定包围盒的范围 </span></span><br><span class="line">    <span class="type">float</span> x_min = std::<span class="built_in">min</span>(std::<span class="built_in">min</span>(v[<span class="number">0</span>].<span class="built_in">x</span>(), v[<span class="number">1</span>].<span class="built_in">x</span>()), v[<span class="number">2</span>].<span class="built_in">x</span>());</span><br><span class="line">    <span class="type">float</span> y_min = std::<span class="built_in">min</span>(std::<span class="built_in">min</span>(v[<span class="number">0</span>].<span class="built_in">y</span>(), v[<span class="number">1</span>].<span class="built_in">y</span>()), v[<span class="number">2</span>].<span class="built_in">y</span>());</span><br><span class="line">    <span class="type">float</span> x_max = std::<span class="built_in">max</span>(std::<span class="built_in">max</span>(v[<span class="number">0</span>].<span class="built_in">x</span>(), v[<span class="number">1</span>].<span class="built_in">x</span>()), v[<span class="number">2</span>].<span class="built_in">x</span>());</span><br><span class="line">    <span class="type">float</span> y_max = std::<span class="built_in">max</span>(std::<span class="built_in">max</span>(v[<span class="number">0</span>].<span class="built_in">y</span>(), v[<span class="number">1</span>].<span class="built_in">y</span>()), v[<span class="number">2</span>].<span class="built_in">y</span>());</span><br><span class="line">    x_min = (<span class="type">int</span>)std::<span class="built_in">floor</span>(x_min);</span><br><span class="line">    x_max = (<span class="type">int</span>)std::<span class="built_in">ceil</span>(x_max);</span><br><span class="line">    y_min = (<span class="type">int</span>)std::<span class="built_in">floor</span>(y_min);</span><br><span class="line">    y_max = (<span class="type">int</span>)std::<span class="built_in">ceil</span>(y_max);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历包围盒中的像素，并判断其是否在三角形范围内</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> x = x_min; x &lt;= x_max; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> y = y_min; y &lt;= y_max; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">insideTriangle</span>(x + <span class="number">0.5</span>, y + <span class="number">0.5</span>, t.v))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果在，就用重心坐标计算对应的插值深度值</span></span><br><span class="line">                <span class="keyword">auto</span> tup = <span class="built_in">computeBarycentric2D</span>(x, y, t.v);</span><br><span class="line">                <span class="type">float</span> alpha, beta, gamma;</span><br><span class="line">                std::<span class="built_in">tie</span>(alpha, beta, gamma) = tup;</span><br><span class="line">                <span class="type">float</span> w_reciprocal = <span class="number">1.0</span>/(alpha / v[<span class="number">0</span>].<span class="built_in">w</span>() + beta / v[<span class="number">1</span>].<span class="built_in">w</span>() + gamma / v[<span class="number">2</span>].<span class="built_in">w</span>());</span><br><span class="line">                <span class="type">float</span> z_interpolated = alpha * v[<span class="number">0</span>].<span class="built_in">z</span>() / v[<span class="number">0</span>].<span class="built_in">w</span>() + beta * v[<span class="number">1</span>].<span class="built_in">z</span>() / v[<span class="number">1</span>].<span class="built_in">w</span>() + gamma * v[<span class="number">2</span>].<span class="built_in">z</span>() / v[<span class="number">2</span>].<span class="built_in">w</span>();</span><br><span class="line">                z_interpolated *= w_reciprocal;</span><br><span class="line">                <span class="comment">// ↑重心坐标插值代码由助教提供</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 深度检测：与深度缓冲区中的值进行比较，如果离摄像机更近，那就绘制并更新缓冲区</span></span><br><span class="line">                <span class="keyword">if</span> (z_interpolated &lt; depth_buf[<span class="built_in">get_index</span>(x, y)])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">set_pixel</span>(<span class="built_in">Vector3f</span>(x, y, z_interpolated), t.<span class="built_in">getColor</span>());</span><br><span class="line">                    depth_buf[<span class="built_in">get_index</span>(x, y)] = z_interpolated;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>课程中暂未涉及重心坐标插值，该部分代码由助教提供。如果对此感兴趣，可以看一下这篇文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/149836719">计算机图形学 1：重心坐标系（Barycentric coordinate system）详解</a></p>
<h2 id="抗锯齿-反走样"><a href="#抗锯齿-反走样" class="headerlink" title="抗锯齿/反走样"></a>抗锯齿/反走样</h2><p>作业02的附加题如下：</p>
<blockquote>
<p>[提高项 5 分] 用 super-sampling 处理 Anti-aliasing : 你可能会注意到，当我们放大图像时，图像边缘会有锯齿感。我们可以用 super-sampling来解决这个问题，即对每个像素进行 2 * 2 采样，并比较前后的结果 (这里并不需要考虑像素与像素间的样本复用)。需要注意的点有，对于像素内的每一个样本都需要维护它自己的深度值，即每一个像素都需要维护一个 sample list。最后，如果你实现正确的话，你得到的三角形不应该有不正常的黑边。</p>
</blockquote>
<p>图像边缘有“锯齿”，从信号处理的角度看，这是因为采样的频率低于图像的频率。我们用有限离散的像素点去逼近连续的三角形，自然会出现这种锯齿走样的现象。以下将介绍两种反走样的方法，第二种可以当成第一种的改良。</p>
<p>参考文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/484890144">MSAA和SSAA的详细说明</a></p>
<h3 id="超采样反走样（Super-Sampling-AA）"><a href="#超采样反走样（Super-Sampling-AA）" class="headerlink" title="超采样反走样（Super Sampling AA）"></a>超采样反走样（Super Sampling AA）</h3><p>SSAA的动机非常简单。如果有限离散像素点逼近结果不好，那就用更多的采样点去逼近。我们将原来的每个像素点进行细分。例如，我们可以将一个像素点等分出四个采样点（对应游戏中抗锯齿选项的$\times 2$。对每个采样点计算颜色，然后将像素内部采样点的颜色值全部加起来取平均。</p>
<p><img src="/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/1.jpg" alt="四等分"></p>
<p><img src="/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/2.jpg" alt="取平均"></p>
<p>然而，SSAA存在一定的开销问题。还是以四等分为例：原始的算法会为像素点维护<code>depth_buffer</code>和<code>color_buffer</code>，n个像素点就对应n大小的数组，使用SSAA后，子采样点的深度和颜色也要维护。所以<code>depth_buffer</code>和<code>color_buffer</code>的数组大小就扩充到2*2*n。与此同时，SSAA的计算复杂度也会增大，因为判定是否在三角形内、深度检测和计算着色的操作会增多。</p>
<h3 id="多采样反走样（Multi-Sampling-AA）"><a href="#多采样反走样（Multi-Sampling-AA）" class="headerlink" title="多采样反走样（Multi-Sampling AA）"></a>多采样反走样（Multi-Sampling AA）</h3><p>MSAA是对SSAA的优化。其思路如下：既然最后显示在屏幕上的是各个母像素的颜色，那么直接从子采样点的三角形覆盖情况得到母像素的颜色就行了。</p>
<p><img src="/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/4.jpg" alt="举例"></p>
<p>例如上图中，四个子采样点中有两个在三角形内，在计算完母像素中心的颜色后，将该颜色乘以50%即是最终颜色。以下是MSAA的图示与具体流程：</p>
<p><img src="/wiki/GAMES101/2022-07-09-[03]%E5%85%89%E6%A0%85%E5%8C%96/3.jpg" alt="MSAA"></p>
<ol>
<li>光栅化阶段。对四个$\times$位置的sample执行三角形覆盖判断，在一个四倍分辨率大小的coverage mask中记录每个sample被覆盖的情况，比如下面的2个sample通过了<strong>覆盖测试</strong>，则掩码为0011。</li>
<li>像素着色阶段。对至少有1个sample通过了覆盖测试的<strong>像素着色</strong>，用像素中心点或者某个已覆盖的sample的坐标执行像素着色器。（注：有的时候，三角形可能没有覆盖到像素的中心位置，这时候如果再使用像素中心点的坐标着色，就可能得到错误的渲染效果。GPU硬件会使用<strong>centroid sampling</strong>来调整采样点的位置，当像素中心点被覆盖时，是正常的像素中心点的采样，而当像素中心点未被三角形覆盖时，GPU就会挑选最近的通过覆盖测试的次像素点，作为采样点。）</li>
<li>对4个sample中通过覆盖测试的执行<strong>深度测试</strong>，并将测试通过的sample插值得来的深度值写入深度缓冲。每个sample都拥有自己的深度值。</li>
<li>上图中左下两个sample通过了深度测试，并且coverage mask为1，因此将像素着色阶段得到的颜色copy到这两个sample对应的颜色缓冲中（依然是每个sample一个颜色，共四倍大小）。其他两个sample暂为背景色。</li>
<li>重复上述流程绘制第二个黄色三角形，将像素着色获得的黄色复制到右上角的sample中。</li>
<li>所有绘制结束之后，将四个sample的颜色resolve获得最终输出的像素颜色。一般情况下，MSAA是硬件直接用box filter进行resolve，也就是将像素中对应的次像素点中的颜色直接取平均值。</li>
</ol>
<p>MSAA与SSAA的最大区别在于，SSAA对像素内的<strong>所有采样点</strong>进行shader计算；而MSAA只选择像素中的一个sample作为采样点，具体挑选哪个点详见第2步。这样就节省了很大一部分的计算开销，尽管MSAA的内存开销还是和SSAA一样多。</p>
<script type="math/tex; mode=display">
\bf{END.}</script>
            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
    
        <a href="/wiki/GAMES101/2022-07-08-%5B02%5D%E8%A7%86%E5%9B%BE%E5%8F%98%E6%8D%A2/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">02. 视图变换</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Solitude21 &copy; 2022 
            <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>